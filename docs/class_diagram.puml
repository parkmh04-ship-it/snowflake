@startuml
skinparam classAttributeIconSize 0
skinparam componentStyle uml2
skinparam linetype ortho

title Snowflake URL Shorter - Class Diagram (Multi-Module, Hexagonal)

' --- Module: snowflake-core ---
package "Module: snowflake-core" #EEEEEE {
    package "io.dave.snowflake.domain.generator" {
        interface IdGenerator {
            +nextId(): Long
        }
        class SnowflakeIdGenerator {
            -workerId: Long
            -timeSource: Supplier<Long>
            -lastTimestamp: Long
            -sequence: Long
            +nextId(): Long
        }
        class PooledIdGenerator {
            -idGenerators: List<IdGenerator>
            -index: AtomicInteger
            +nextId(): Long
        }
        class Base62Encoder {
            {static} +ALPHABET: String
            {static} +encode(id: Long): String
        }
    }
}

' --- Module: snowflake-shorter-domain ---
package "Module: snowflake-shorter-domain" #CCFFCC {
    package "io.dave.snowflake.domain.model" {
        class ShortUrl {
            +value: String
        }
        class LongUrl {
            +value: String
        }
        class UrlMapping {
            +shortUrl: ShortUrl
            +longUrl: LongUrl
            +createdAt: Long
        }
    }

    package "io.dave.snowflake.domain.port" {
        interface RateLimiter {
            +isAllowed(key: String, limit: Int, windowInSeconds: Int): Boolean
        }
        package "outbound" {
            interface UrlPort {
                +save(mapping: UrlMapping): UrlMapping
                +findByShortUrl(shortUrl: ShortUrl): UrlMapping?
                +existsByShortUrl(shortUrl: ShortUrl): Boolean
            }
            interface WorkerPort {
                +findByWorkerNums(workerNums: List<Long>): Flow<Worker>
                +updateUpdatedAt(workerNums: List<Long>, updatedAt: LocalDateTime): Int
                +saveAll(workers: Flow<Worker>): Flow<Worker>
            }
            interface WorkerIdRepository {
                +assignWorkerIds(instanceId: String, requiredCount: Int): List<Long>
            }
        }
    }

    package "io.dave.snowflake.domain.component" {
        class ShortUrlGenerator <<Domain Service>> {
            -idGenerator: PooledIdGenerator
            -urlPort: UrlPort
            +generate(): ShortUrl
        }
    }
}

' --- Module: snowflake-shorter ---
package "Module: snowflake-shorter" #CCEEFF {
    package "io.dave.snowflake.application.usecase" {
        class ShortenUrlUseCase <<UseCase>> {
            -shortUrlGenerator: ShortUrlGenerator
            -urlPort: UrlPort
            +shorten(longUrlStr: String): UrlMapping
        }
        class RetrieveUrlUseCase <<UseCase>> {
            -urlPort: UrlPort
            +retrieve(shortUrlStr: String): UrlMapping?
        }
    }

    package "io.dave.snowflake.adapter.inbound" {
        class ShorterHandler <<Web Handler>> {
            -shortenUrlUseCase: ShortenUrlUseCase
            -retrieveUrlUseCase: RetrieveUrlUseCase
            +shorten(request: ServerRequest): ServerResponse
            +redirect(request: ServerRequest): ServerResponse
        }
        class RateLimitFilter <<Web Filter>> {
            -rateLimiter: RateLimiter
            +filter(exchange: ServerWebExchange, chain: WebFilterChain): Mono<Void>
        }
    }

    package "io.dave.snowflake.adapter.outbound" {
        package "persistence" {
            class UrlPersistenceAdapter <<Adapter>> {
                -shortUrlRepository: ShortUrlRepository
                +save(mapping: UrlMapping): UrlMapping
                +findByShortUrl(shortUrl: ShortUrl): UrlMapping?
            }
            class WorkerPersistenceAdapter <<Adapter>> {
                -workerRepository: WorkerRepository
                +findByWorkerNums(workerNums: List<Long>): Flow<Worker>
            }
        }
        package "cache" {
            class RedisRateLimiter <<Adapter>> {
                -reactiveRedisTemplate: ReactiveRedisTemplate
                +isAllowed(key: String, limit: Int, windowInSeconds: Int): Boolean
            }
        }
    }

    package "io.dave.snowflake.config.metrics" {
        class MonitoredIdGenerator {
            -delegate: IdGenerator
            -meterRegistry: MeterRegistry
            +nextId(): Long
        }
    }
}

' --- Relationships ---

' Module Dependencies
"Module: snowflake-shorter" ..> "Module: snowflake-shorter-domain" : depends on
"Module: snowflake-shorter" ..> "Module: snowflake-core" : depends on
"Module: snowflake-shorter-domain" ..> "Module: snowflake-core" : depends on

' Implementation
IdGenerator <|.. SnowflakeIdGenerator
IdGenerator <|.. PooledIdGenerator
IdGenerator <|.. MonitoredIdGenerator

RateLimiter <|.. RedisRateLimiter
UrlPort <|.. UrlPersistenceAdapter
WorkerPort <|.. WorkerPersistenceAdapter

' Usage
ShortenUrlUseCase --> ShortUrlGenerator : uses
ShortenUrlUseCase --> UrlPort : uses
ShorterHandler --> ShortenUrlUseCase : uses
RateLimitFilter --> RateLimiter : uses
ShortUrlGenerator --> PooledIdGenerator : uses
ShortUrlGenerator --> UrlPort : uses
MonitoredIdGenerator o-- IdGenerator : decorates

@enduml