@startuml
autonumber

title Snowflake URL Shorter Sequences (Rate Limiting & Correlation)

actor Client
participant "RateLimitFilter\n(Filter)" as Filter
participant "RedisRateLimiter\n(Adapter)" as RedisLimiter
participant "ShorterHandler\n(Handler)" as Handler
participant "ShortenUrlUseCase\n(UseCase)" as UseCase
participant "ShortUrlGenerator\n(Domain Service)" as Generator
participant "UrlPort\n(Port)" as UrlPort
participant "UrlPersistenceAdapter\n(Adapter)" as UrlAdapter
database "Redis" as Redis
database "MySQL" as DB

== Scenario 1: Shorten URL with Rate Limiting ==

Client -> Filter: POST /shorten
activate Filter

    Filter -> RedisLimiter: isAllowed(IP)
    activate RedisLimiter
        RedisLimiter -> Redis: EVAL "ratelimit.lua"
        activate Redis
        Redis --> RedisLimiter: Allowed (true)
        deactivate Redis
    RedisLimiter --> Filter: true
    deactivate RedisLimiter

    Filter -> Handler: handleRequest
    activate Handler

        Handler -> UseCase: shorten(longUrl)
        activate UseCase

            UseCase -> UrlPort: findByLongUrl(longUrl)
            activate UrlPort
                UrlPort -> UrlAdapter: findByLongUrl
                activate UrlAdapter
                    UrlAdapter -> DB: SELECT ...
                    activate DB
                    DB --> UrlAdapter: null
                    deactivate DB
                UrlAdapter --> UrlPort: null
                deactivate UrlAdapter
            UrlPort --> UseCase: null
            deactivate UrlPort

            UseCase -> Generator: generate()
            activate Generator
                Generator -> Generator: Generate Snowflake ID\n(Base62 Encode)
                Generator -> UrlPort: existsByShortUrl
                activate UrlPort
                    UrlPort -> UrlAdapter: exists
                    UrlAdapter -> DB: EXISTS
                UrlPort --> Generator: false
                deactivate UrlPort
            Generator --> UseCase: ShortUrl
            deactivate Generator

            UseCase -> UrlPort: save(mapping)
            activate UrlPort
                UrlPort -> UrlAdapter: save
                activate UrlAdapter
                    UrlAdapter -> DB: INSERT (Async/Batch)
                UrlAdapter --> UrlPort: Mapping
                deactivate UrlAdapter
            UrlPort --> UseCase: Mapping
            deactivate UrlPort

            ' Redis Caching Refactored with Coroutines
            UseCase -> Redis: SET "short:{id}" (awaitSingleOrNull)
            activate Redis
            Redis --> UseCase: OK
            deactivate Redis

        UseCase --> Handler: Result
        deactivate UseCase

    Handler --> Filter: 201 Created
    deactivate Handler

Filter --> Client: 201 Created
deactivate Filter

@enduml