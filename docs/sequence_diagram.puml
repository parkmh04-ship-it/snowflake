@startuml
autonumber

title Snowflake URL Shorter Sequences (Transactional Outbox & Relay)

actor Client
participant "ShorterHandler\n(Web)" as Handler
participant "ShortenUrlUseCase\n(UseCase)" as UseCase
participant "OutboxPort\n(Port)" as OutboxPort
participant "OutboxPersistenceAdapter\n(Adapter)" as OutboxAdapter
participant "Redis" as Redis
participant "OutboundEventPort\n(Port)" as EventPort
participant "OutboxRelayWorker\n(Worker)" as RelayWorker
participant "UrlPort\n(Port)" as UrlPort
database "MySQL" as DB

== Scenario 1: Shorten URL with Outbox ==

Client -> Handler: POST /shorten
activate Handler

    Handler -> UseCase: shorten(longUrl)
    activate UseCase

        UseCase -> UseCase: 1. Generate ShortUrl
        
        group Transactional Outbox [DB Transaction]
            UseCase -> OutboxPort: 2. save(OutboxEvent)
            activate OutboxPort
                OutboxPort -> OutboxAdapter: save
                activate OutboxAdapter
                    OutboxAdapter -> DB: INSERT INTO outbox
                    activate DB
                    DB --> OutboxAdapter: Success
                    deactivate DB
                OutboxAdapter --> OutboxPort: Saved Event
                deactivate OutboxAdapter
            OutboxPort --> UseCase: Success
            deactivate OutboxPort
        end

        UseCase -> Redis: 3. SET Cache (awaitSingleOrNull)
        activate Redis
        Redis --> UseCase: OK
        deactivate Redis

        UseCase -> EventPort: 4. publish(ShortUrlCreatedEvent)
        note right of EventPort: Memory-based async processing\n(for internal monitoring/cache)
        
        UseCase --> Handler: 5. Return Mapping
        deactivate UseCase

    Handler --> Client: 201 Created
    deactivate Handler

== Scenario 2: Outbox Relay Process (Background) ==

loop every 5 seconds
    RelayWorker -> OutboxPort: 1. findUnprocessedEvents(limit)
    activate OutboxPort
        OutboxPort -> DB: SELECT * FROM outbox
    OutboxPort --> RelayWorker: List<OutboxEvent>
    deactivate OutboxPort

    alt Events Exist
        RelayWorker -> RelayWorker: 2. Decode Payloads (JSON)
        
        RelayWorker -> UrlPort: 3. saveAll(mappings)
        activate UrlPort
            UrlPort -> DB: INSERT INTO shorter_history (Batch)
        UrlPort --> RelayWorker: Success
        deactivate UrlPort

        RelayWorker -> OutboxPort: 4. deleteEvents(ids)
        activate OutboxPort
            OutboxPort -> DB: DELETE FROM outbox
        OutboxPort --> RelayWorker: Success
        deactivate OutboxPort
    end
end

@enduml